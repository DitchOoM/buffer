name: "Build and Test"
on:
  pull_request:
    paths-ignore:
      - '*.md'
    types:
      - synchronize
      - opened

jobs:
  review:
    name: "JVM/JS/WASM Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
      - name: Run tests
        run: ./gradlew ktlintCheck jvmTest jsNodeTest jsBrowserTest wasmJsNodeTest wasmJsBrowserTest --no-build-cache

  multi-release-jar:
    name: "Validate Multi-Release JAR"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Build JAR
        run: ./gradlew :buffer:jvmJar --no-build-cache
      - name: Verify JAR structure
        run: |
          JAR_FILE=$(ls buffer/build/libs/buffer-jvm-*.jar | head -1)
          echo "=== Multi-Release JAR Validation ==="
          echo "JAR: $JAR_FILE"

          echo "--- Manifest ---"
          unzip -p "$JAR_FILE" META-INF/MANIFEST.MF

          echo "--- Structure ---"
          jar tf "$JAR_FILE" | grep -E "BufferMismatch|DirectBufferAddress|META-INF/versions"

          echo "--- Validation ---"
          unzip -p "$JAR_FILE" META-INF/MANIFEST.MF | grep -q "Multi-Release: true" || (echo "FAIL: Multi-Release attribute missing" && exit 1)
          echo "✓ Multi-Release: true"

          jar tf "$JAR_FILE" | grep -q "^com/ditchoom/buffer/BufferMismatchHelper.class" || (echo "FAIL: Base class missing" && exit 1)
          echo "✓ Base BufferMismatchHelper.class present"

          jar tf "$JAR_FILE" | grep -q "META-INF/versions/11/com/ditchoom/buffer/BufferMismatchHelper.class" || (echo "FAIL: Java 11 class missing" && exit 1)
          echo "✓ Java 11 BufferMismatchHelper.class present"

          jar tf "$JAR_FILE" | grep -q "META-INF/versions/21/com/ditchoom/buffer/DirectBufferAddressHelperKt.class" || (echo "FAIL: Java 21 class missing" && exit 1)
          echo "✓ Java 21 DirectBufferAddressHelperKt.class present"

          echo "=== JAR structure verified ==="

  android:
    name: "Android Unit Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      - name: Run Android unit tests
        run: ./gradlew testDebugUnitTest testReleaseUnitTest --no-build-cache

  apple:
    name: "Apple Target Tests"
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Cache Konan
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: konan-${{ runner.os }}-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: konan-${{ runner.os }}-
      - name: Run tests and verify Linux cross-compilation
        run: ./gradlew macosArm64Test iosSimulatorArm64Test compileKotlinLinuxX64 compileKotlinLinuxArm64 :buffer-compression:compileLinuxMainKotlinMetadata

  linux:
    name: "Linux Target Tests"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Cache Konan
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: konan-linux-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: konan-linux-
      - name: Cache simdutf x64
        uses: actions/cache@v4
        with:
          path: buffer/libs/simdutf/linux-x64
          key: simdutf-linux-x64-${{ hashFiles('gradle/libs.versions.toml', 'buffer/src/nativeInterop/cinterop/simdutf_wrapper.cpp') }}
      - name: Cache simdutf ARM64
        uses: actions/cache@v4
        with:
          path: buffer/libs/simdutf/linux-arm64
          key: simdutf-linux-arm64-${{ hashFiles('gradle/libs.versions.toml', 'buffer/src/nativeInterop/cinterop/simdutf_wrapper.cpp') }}
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential qemu-user-static
          # ARM64 cross-compilation toolchain
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          # ARM64 runtime libraries for QEMU
          mkdir -p /tmp/arm64-libs
          cd /tmp/arm64-libs
          curl -LO http://ports.ubuntu.com/pool/main/libx/libxcrypt/libcrypt1_4.4.36-4build1_arm64.deb
          ar x libcrypt1_*.deb
          tar xf data.tar.zst
          sudo cp -r usr/lib/aarch64-linux-gnu/* /usr/aarch64-linux-gnu/lib/
          # ARM64 zlib for buffer-compression QEMU tests
          curl -LO http://ports.ubuntu.com/pool/main/z/zlib/zlib1g_1.3.dfsg-3.1ubuntu2_arm64.deb
          ar x zlib1g_*.deb
          tar xf data.tar.zst
          sudo cp -r lib/aarch64-linux-gnu/* /usr/aarch64-linux-gnu/lib/
      - name: Run buffer Linux x64 tests
        run: ./gradlew :buffer:linuxX64Test --no-build-cache
      - name: Run compression Linux x64 tests
        run: ./gradlew :buffer-compression:linuxX64Test --no-build-cache
      - name: Build ARM64 test binaries
        run: ./gradlew :buffer:linkDebugTestLinuxArm64 :buffer-compression:linkDebugTestLinuxArm64 --no-build-cache
      - name: Run buffer ARM64 tests via QEMU
        run: qemu-aarch64-static -L /usr/aarch64-linux-gnu ./buffer/build/bin/linuxArm64/debugTest/test.kexe
      - name: Run buffer-compression ARM64 tests via QEMU
        run: qemu-aarch64-static -L /usr/aarch64-linux-gnu ./buffer-compression/build/bin/linuxArm64/debugTest/test.kexe
      - name: Verify simdutf in Linux klib
        run: |
          ./gradlew :buffer:publishLinuxX64PublicationToMavenLocal :buffer:publishLinuxArm64PublicationToMavenLocal --no-build-cache
          KLIB_X64=$(find ~/.m2/repository/com/ditchoom/buffer-linuxx64 -name "*.klib" | head -1)
          KLIB_ARM64=$(find ~/.m2/repository/com/ditchoom/buffer-linuxarm64 -name "*.klib" | head -1)
          echo "=== simdutf klib Validation ==="
          for KLIB in "$KLIB_X64" "$KLIB_ARM64"; do
            echo "Checking: $KLIB"
            if [ -z "$KLIB" ]; then echo "FAIL: klib not found" && exit 1; fi
            unzip -l "$KLIB" | grep -q "libsimdutf.a" || (echo "FAIL: libsimdutf.a missing from $KLIB" && exit 1)
            unzip -l "$KLIB" | grep -q "libsimdutf_wrapper.a" || (echo "FAIL: libsimdutf_wrapper.a missing from $KLIB" && exit 1)
            echo "✓ simdutf libraries present"
          done
          echo "=== Validation passed ==="

  docs:
    name: "Validate Docs Generation"
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Cache Konan
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: konan-${{ runner.os }}-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: konan-${{ runner.os }}-
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json
      - name: Generate API Documentation with Dokka
        run: ./gradlew copyDokkaToDocusaurus
      - name: Install docs dependencies
        working-directory: docs
        run: npm ci
      - name: Build docs site
        working-directory: docs
        run: npm run build
