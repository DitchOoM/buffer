name: "Build Test and Deploy"
on:
  pull_request_target:
    branches: [ main ]
    types:
      - closed

permissions:
  contents: write

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  check-release:
    name: Check if release is needed
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      flow: ${{ steps.check.outputs.flow }}
      gradle-args: ${{ steps.check.outputs.gradle-args }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine release flow
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gradle_args=""
          if ${{ contains(github.event.pull_request.labels.*.name, 'major') }}; then
            gradle_args="-PincrementMajor=true"
          elif ${{ contains(github.event.pull_request.labels.*.name, 'minor') }}; then
            gradle_args="-PincrementMinor=true"
          fi
          echo "gradle-args=${gradle_args}" >> $GITHUB_OUTPUT

          # Check for skip-release label
          if ${{ contains(github.event.pull_request.labels.*.name, 'skip-release') }}; then
            echo "flow=dry-run" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for draft-release label
          if ${{ contains(github.event.pull_request.labels.*.name, 'draft-release') }}; then
            echo "flow=draft" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if only non-code files changed
          changed_files=$(gh pr diff ${{ github.event.pull_request.number }} --name-only)
          for file in $changed_files; do
            case "$file" in
              .github/*|*.md|.gitignore|.editorconfig|CLAUDE.md|LICENSE|*.txt)
                ;;
              *)
                echo "Code file changed: $file"
                echo "flow=release" >> $GITHUB_OUTPUT
                exit 0
                ;;
            esac
          done

          echo "Only non-code files changed, skipping"
          echo "flow=skip" >> $GITHUB_OUTPUT

  build-linux:
    needs: check-release
    if: needs.check-release.outputs.flow != 'skip'
    uses: ./.github/workflows/build-linux.yaml
    with:
      gradle-args: ${{ needs.check-release.outputs.gradle-args }}

  build-apple:
    needs: check-release
    if: needs.check-release.outputs.flow != 'skip'
    uses: ./.github/workflows/build-apple.yaml
    with:
      gradle-args: ${{ needs.check-release.outputs.gradle-args }}

  validate:
    needs: [check-release, build-linux, build-apple]
    if: needs.check-release.outputs.flow != 'skip'
    uses: ./.github/workflows/validate-artifacts.yaml
    with:
      version: ${{ needs.build-linux.outputs.version }}

  publish:
    needs: [check-release, validate]
    if: needs.check-release.outputs.flow == 'draft' || needs.check-release.outputs.flow == 'release'
    uses: ./.github/workflows/publish-to-central.yaml
    with:
      publishing-type: ${{ needs.check-release.outputs.flow == 'draft' && 'USER_MANAGED' || 'AUTOMATIC' }}
      version: ${{ needs.build-linux.outputs.version }}
    secrets:
      GPG_KEY_CONTENTS: ${{ secrets.GPG_KEY_CONTENTS }}
      SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
      MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
      MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

  finalize:
    name: Finalize Release
    needs: [check-release, build-linux, publish]
    if: always() && needs.check-release.outputs.flow != 'skip' && needs.check-release.outputs.flow != 'dry-run'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create draft GitHub release
        if: needs.check-release.outputs.flow == 'draft' && needs.publish.result == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          version="${{ needs.build-linux.outputs.version }}"
          deployment_id="${{ needs.publish.outputs.deployment-id }}"
          staging_url="https://central.sonatype.com/publishing/deployments"

          gh release create "v${version}" \
              --draft \
              --repo="$GITHUB_REPOSITORY" \
              --title="v${version}" \
              --notes="$(cat <<EOF
          ## [${PR_TITLE}](${PR_URL})

          **Status:** Awaiting validation in [Maven Central Staging](${staging_url})
          **Deployment ID:** \`${deployment_id}\`

          ### To complete release:
          1. Validate artifacts in Maven Central staging area
          2. Run the 'Complete or Cancel Release' workflow with action 'complete' and version '${version}'

          ### To cancel:
          1. Run the 'Complete or Cancel Release' workflow with action 'cancel' and version '${version}'
          2. This will drop the deployment and delete this draft release
          EOF
          )"

      - name: Create tag and GitHub release
        if: needs.check-release.outputs.flow == 'release' && needs.publish.result == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          version="${{ needs.build-linux.outputs.version }}"
          tag="v${version}"

          # Check if tag already exists
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists, skipping"
            exit 0
          fi

          # Create and push tag
          git tag "$tag"
          git push origin "$tag"

          # Create release
          maven_url="https://central.sonatype.com/artifact/com.ditchoom/buffer/${version}"
          gh release create "$tag" \
              --repo="$GITHUB_REPOSITORY" \
              --title="${tag}" \
              --notes="$(cat <<EOF
          ## [${PR_TITLE}](${PR_URL})

          **Maven Central:** [com.ditchoom:buffer:${version}](${maven_url})
          EOF
          )"
